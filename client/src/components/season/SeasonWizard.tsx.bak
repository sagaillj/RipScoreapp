import { useState, useEffect } from 'react';
import confetti from 'canvas-confetti';
import { useMutation } from '@tanstack/react-query';
import { useAuth } from '@/hooks/use-auth';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { Checkbox } from '@/components/ui/checkbox';
import { Switch } from '@/components/ui/switch';
import { Calendar } from '@/components/ui/calendar';
import { 
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { cn } from '@/lib/utils';
import { format } from 'date-fns';
import { CalendarIcon, ChevronRight, PlusCircle, Trash2 } from 'lucide-react';
import { apiRequest, queryClient } from '@/lib/queryClient';
import { Season } from '@/types';
import { useToast } from '@/hooks/use-toast';

// Schema for the base season info
const seasonFormSchema = z.object({
  name: z.string().min(1, "Season name is required"),
  startYear: z.coerce.number().min(2000).max(2100),
  endYear: z.coerce.number().min(2000).max(2100),
});

// Schema for the season cycles
const stageSchema = z.object({
  type: z.enum(['preseason', 'regular', 'postseason', 'offseason']),
  startDate: z.date({ required_error: "Start date is required" }),
});

// Schema for the meets
const meetSchema = z.object({
  opponent: z.string().min(1, "Opponent name is required"),
  isHome: z.boolean().default(true),
  cycleType: z.enum(['preseason', 'regular', 'postseason']),
  date: z.date({ required_error: "Date is required" }),
  startTime: z.string().optional(),
});

// Schema for practice schedules
const practiceSchema = z.object({
  name: z.string().min(1, "Practice name is required"),
  type: z.enum(['weightroom', 'dryland', 'diving', 'mental', 'other']),
  repeatEvery: z.number().min(1).default(1),
  repeatUnit: z.enum(['day', 'week', 'month']).default('week'),
  repeatDays: z.array(z.number().min(0).max(6)).default([1, 3, 5]), // Mon, Wed, Fri by default
  startTime: z.string(),
  endTime: z.string(),
  location: z.string().optional(),
  endOption: z.enum(['never', 'on', 'after']).default('never'),
  endDate: z.date().optional(),
  endOccurrences: z.number().min(1).default(10).optional(),
  notes: z.string().optional(),
});

interface SeasonWizardProps {
  season?: Season | null;
  isOpen: boolean;
  onClose: () => void;
  onComplete: () => void;
}

export function SeasonWizard({ season, isOpen, onClose, onComplete }: SeasonWizardProps) {
  const { user } = useAuth();
  const [step, setStep] = useState(2);
  const [showConfetti, setShowConfetti] = useState(false);
  
  useEffect(() => {
    if (showConfetti) {
      // Launch confetti
      const duration = 2000;
      const end = Date.now() + duration;
      
      (function frame() {
        confetti({
          particleCount: 2,
          angle: 60,
          spread: 55,
          origin: { x: 0 },
          colors: ['#ff49db', '#0099ff', '#ff7849', '#13b4ff']
        });
        confetti({
          particleCount: 2,
          angle: 120,
          spread: 55,
          origin: { x: 1 },
          colors: ['#ff49db', '#0099ff', '#ff7849', '#13b4ff']
        });

        if (Date.now() < end) {
          requestAnimationFrame(frame);
        } else {
          setShowConfetti(false);
        }
      }());
    }
  }, [showConfetti]);
  const [stages, setStages] = useState<z.infer<typeof stageSchema>[]>([
    { type: 'preseason', startDate: new Date() },
    { type: 'regular', startDate: new Date(new Date().setMonth(new Date().getMonth() + 1)) },
    { type: 'postseason', startDate: new Date(new Date().setMonth(new Date().getMonth() + 3)) },
    { type: 'offseason', startDate: new Date(new Date().setMonth(new Date().getMonth() + 4)) }
  ]);
  const [meets, setMeets] = useState<z.infer<typeof meetSchema>[]>([]);
  const [practices, setPractices] = useState<z.infer<typeof practiceSchema>[]>([]);
  
  // Form for the base season info
  const form = useForm<z.infer<typeof seasonFormSchema>>({
    resolver: zodResolver(seasonFormSchema),
    defaultValues: {
      name: season?.name || "",
      startYear: season?.startYear || new Date().getFullYear(),
      endYear: season?.endYear || new Date().getFullYear() + 1,
    }
  });

  // Form for adding a new stage
  const stageForm = useForm<z.infer<typeof stageSchema>>({
    resolver: zodResolver(stageSchema),
    defaultValues: {
      type: 'preseason',
      startDate: new Date(),
    }
  });

  // Form for adding a new meet
  const meetForm = useForm<z.infer<typeof meetSchema>>({
    resolver: zodResolver(meetSchema),
    defaultValues: {
      opponent: '',
      isHome: true,
      cycleType: 'regular',
      date: new Date(),
      startTime: '12:00',
    }
  });

  // Form for adding a new practice schedule
  const practiceForm = useForm<z.infer<typeof practiceSchema>>({
    resolver: zodResolver(practiceSchema),
    defaultValues: {
      name: 'Regular Practice',
      type: 'diving',
      repeatEvery: 1,
      repeatUnit: 'week',
      repeatDays: [1, 3, 5], // Mon, Wed, Fri
      startTime: '15:00',
      endTime: '17:00',
      location: '',
      endOption: 'never',
      endDate: new Date(new Date().setMonth(new Date().getMonth() + 3)),
      endOccurrences: 10,
      notes: '',
    }
  });

  // Create season mutation
  const createSeasonMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await apiRequest('POST', '/api/seasons', {
        ...data,
        teamId: user?.role === 'coach' ? (user as any).teamId : null,
        createdBy: user?.id,
        status: 'active',
      });
      return await response.json();
    },
    onSuccess: async (newSeason) => {
      // Create stages
      for (const stage of stages) {
        await apiRequest('POST', '/api/season-cycles', {
          ...stage,
          seasonId: newSeason.id,
        });
      }
      
      // Create meets
      for (const meet of meets) {
        // First create the base meet
        const meetResponse = await apiRequest('POST', '/api/meets', {
          name: `vs ${meet.opponent}`,
          location: meet.isHome ? 'Home' : 'Away',
          date: meet.date,
          status: 'upcoming',
          createdBy: user?.id,
        });
        const newMeet = await meetResponse.json();
        
        // Then create the season-meet association
        await apiRequest('POST', '/api/season-meets', {
          seasonId: newSeason.id,
          meetId: newMeet.id,
          opponent: meet.opponent,
          isHome: meet.isHome,
          cycleType: meet.cycleType,
          startTime: meet.startTime,
        });
      }
      
      // Create practice schedules
      for (const practice of practices) {
        await apiRequest('POST', '/api/practice-schedules', {
          ...practice,
          seasonId: newSeason.id,
        });
      }
      
      // Invalidate queries
      queryClient.invalidateQueries({ queryKey: ['/api/teams', user?.role === 'coach' ? (user as any).teamId : null, 'seasons'] });
      
      onComplete();
    },
  });

  const handleAddStage = (data: z.infer<typeof stageSchema>) => {
    setStages([...stages, data]);
    stageForm.reset();
  };

  const handleRemoveStage = (index: number) => {
    setStages(stages.filter((_, i: number) => i !== index));
  };

  const handleAddMeet = (data: z.infer<typeof meetSchema>) => {
    setMeets([...meets, data]);
    meetForm.reset();
  };

  const handleRemoveMeet = (index: number) => {
    setMeets(meets.filter((_, i) => i !== index));
  };

  const handleAddPractice = (data: z.infer<typeof practiceSchema>) => {
    setPractices([...practices, data]);
    practiceForm.reset();
  };

  const handleRemovePractice = (index: number) => {
    setPractices(practices.filter((_, i) => i !== index));
  };

  const nextStep = () => {
    setStep(step + 1);
  };

  const prevStep = () => {
    setStep(step - 1);
  };

  const { toast } = useToast();
  
  const submitSeason = async (data: z.infer<typeof seasonFormSchema>) => {
    try {
      await createSeasonMutation.mutateAsync(data);
      
      // Trigger confetti celebration
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
      
      toast({
        title: "Season created successfully!",
        description: `${data.name} has been created.`,
      });
      
      // Wait briefly to show the confetti before closing
      setTimeout(() => {
        onComplete(); // Signal completion
        onClose(); // Close the wizard
      }, 1000);
    } catch (error) {
      console.error("Failed to create season:", error);
      toast({
        title: "Failed to create season",
        description: "There was an error creating your season. Please try again.",
        variant: "destructive"
      });
    }
  };
  
  // Get the day name from the day number
  const getDayName = (day: number) => {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days[day];
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[600px] max-h-[85vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {season ? 'Edit Season' : 'New Season Creation Wizard'}
          </DialogTitle>
        </DialogHeader>

        {step === 1 && (
          <div className="space-y-4 py-4">
            <h2 className="text-lg font-semibold">Season Basic Information</h2>
            <Form {...form}>
              <form onSubmit={form.handleSubmit(nextStep)} className="space-y-4">
                <FormField
                  control={form.control}
                  name="name"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Season Name</FormLabel>
                      <FormControl>
                        <Input placeholder="2025 Diving Season" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="startYear"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Start Year</FormLabel>
                        <FormControl>
                          <Input type="number" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="endYear"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>End Year</FormLabel>
                        <FormControl>
                          <Input type="number" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <DialogFooter>
                  <Button type="submit">
                    Next Step <ChevronRight className="ml-2 h-4 w-4" />
                  </Button>
                </DialogFooter>
              </form>
            </Form>
          </div>
        )}

        {step === 2 && (
          <div className="space-y-4 py-4">
            <h2 className="text-lg font-semibold">Season Stages</h2>
            <p className="text-sm text-gray-500">
              Define the different periods of your season.
            </p>
            
            <Separator className="my-4" />

            <div className="space-y-2">
              <div className="flex justify-between items-center">
                <h3 className="text-md font-medium">Season Stages</h3>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    // Create a new stage with default values
                    const newStage = {
                      type: 'preseason' as 'preseason' | 'regular' | 'postseason' | 'offseason',
                      startDate: new Date()
                    };
                    setStages([...stages, newStage]);
                  }}
                  className="h-8 px-2"
                >
                  <PlusCircle className="h-4 w-4 mr-1" /> Add Stage
                </Button>
              </div>
              {stages.length === 0 ? (
                <p className="text-sm text-gray-500">No stages added yet.</p>
              ) : (
                <div className="space-y-2">
                  {stages.map((stage, index) => (
                    <div key={index} className="flex items-center justify-between rounded-md border p-3">
                      <div className="flex-grow">
                        <div className="flex items-center">
                          <select
                            className="font-medium capitalize bg-transparent border-none text-base focus:outline-none p-0 mr-2"
                            value={stage.type}
                            onChange={(e) => {
                              const updatedStages = [...stages];
                              updatedStages[index] = { 
                                ...updatedStages[index], 
                                type: e.target.value as "preseason" | "regular" | "postseason" | "offseason" 
                              };
                              setStages(updatedStages);
                            }}
                          >
                            <option value="preseason">Preseason</option>
                            <option value="regular">Regular Season</option>
                            <option value="postseason">Post Season</option>
                            <option value="offseason">Off Season</option>
                          </select>
                        </div>
                        <div className="flex items-center">
                          <span className="text-sm text-gray-500 mr-2">Starting:</span>
                          <Popover>
                            <PopoverTrigger asChild>
                              <Button
                                variant="ghost"
                                className="h-auto p-0 text-sm text-gray-500 font-normal hover:bg-transparent"
                              >
                                {format(stage.startDate, "PPP")}
                              </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0" align="start">
                              <Calendar
                                mode="single"
                                selected={stage.startDate}
                                onSelect={(date) => {
                                  if (date) {
                                    const updatedStages = [...stages];
                                    updatedStages[index] = { ...updatedStages[index], startDate: date };
                                    setStages(updatedStages);
                                  }
                                }}
                                initialFocus
                                className="rounded-md border shadow p-3"
                                showOutsideDays
                                fixedWeeks
                                captionLayout="dropdown-buttons"
                                fromYear={2024}
                                toYear={2030}
                              />
                            </PopoverContent>
                          </Popover>
                        </div>
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => handleRemoveStage(index)}
                      >
                        <Trash2 className="h-4 w-4 text-red-500" />
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <DialogFooter className="flex justify-between">
              <Button variant="outline" onClick={prevStep}>
                Back
              </Button>
              <Button onClick={nextStep}>
                Next Step <ChevronRight className="ml-2 h-4 w-4" />
              </Button>
            </DialogFooter>
          </div>
        )}

        {step === 3 && (
          <div className="space-y-4 py-4">
            <h2 className="text-lg font-semibold">Meets Schedule</h2>
            <p className="text-sm text-gray-500">
              Add meets to your season calendar.
            </p>

            <div className="border rounded-lg p-4 bg-gray-50">
              <Form {...meetForm}>
                <form onSubmit={meetForm.handleSubmit(handleAddMeet)} className="space-y-2">
                  <div className="grid grid-cols-3 gap-3">
                    <div className="col-span-2">
                      <FormField
                        control={meetForm.control}
                        name="opponent"
                        render={({ field }) => (
                          <FormItem className="space-y-1">
                            <FormLabel className="text-xs">Opponent</FormLabel>
                            <FormControl>
                              <Input placeholder="Opposing team name" {...field} className="h-9" />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                    
                    <FormField
                      control={meetForm.control}
                      name="isHome"
                      render={({ field }) => (
                        <FormItem className="pt-5">
                          <div className="flex items-center justify-between space-x-2">
                            <FormLabel className="text-xs font-normal">{field.value ? 'Home' : 'Away'}</FormLabel>
                            <FormControl>
                              <Switch
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                          </div>
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <FormField
                      control={meetForm.control}
                      name="date"
                      render={({ field }) => (
                        <FormItem className="space-y-1">
                          <FormLabel className="text-xs">Date</FormLabel>
                          <Popover>
                            <PopoverTrigger asChild>
                              <FormControl>
                                <Button
                                  variant="outline"
                                  className="w-full h-9 pl-3 text-left font-normal text-sm"
                                >
                                  {field.value ? (
                                    format(field.value, "MMM d, yyyy")
                                  ) : (
                                    <span>Pick a date</span>
                                  )}
                                  <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                                </Button>
                              </FormControl>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0" align="start">
                              <Calendar
                                mode="single"
                                selected={field.value}
                                onSelect={field.onChange}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={meetForm.control}
                      name="startTime"
                      render={({ field }) => (
                        <FormItem className="space-y-1">
                          <FormLabel className="text-xs">Start Time</FormLabel>
                          <FormControl>
                            <Input type="time" {...field} className="h-9" />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <Button type="submit" size="sm" className="w-full mt-2">
                    Add Meet
                  </Button>
                </form>
              </Form>
            </div>

            <Separator className="my-4" />

            <div className="space-y-2">
              <h3 className="text-md font-medium">Added Meets</h3>
              {meets.length === 0 ? (
                <p className="text-sm text-gray-500">No meets added yet.</p>
              ) : (
                <div className="space-y-2">
                  {meets.map((meet, index) => (
                    <div key={index} className="flex items-center justify-between rounded-md border p-3">
                      <div>
                        <p className="font-medium">vs {meet.opponent}</p>
                        <p className="text-sm text-gray-500">
                          {format(meet.date, "PPP")} • {meet.startTime} • {meet.isHome ? 'Home' : 'Away'}
                        </p>
                        <p className="text-xs text-gray-500 capitalize">
                          {meet.cycleType}
                        </p>
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => handleRemoveMeet(index)}
                      >
                        <Trash2 className="h-4 w-4 text-red-500" />
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <DialogFooter className="flex justify-between">
              <Button variant="outline" onClick={prevStep}>
                Back
              </Button>
              <Button onClick={nextStep}>
                Next Step <ChevronRight className="ml-2 h-4 w-4" />
              </Button>
            </DialogFooter>
          </div>
        )}

        {step === 4 && (
          <div className="space-y-4 py-4">
            <h2 className="text-lg font-semibold">Practice Schedule</h2>
            <p className="text-sm text-gray-500">
              Set up your default practice schedule.
            </p>

            <Form {...practiceForm}>
              <form onSubmit={practiceForm.handleSubmit(handleAddPractice)} className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={practiceForm.control}
                    name="name"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Practice Name</FormLabel>
                        <FormControl>
                          <Input placeholder="Regular Practice" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={practiceForm.control}
                    name="type"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Practice Type</FormLabel>
                        <select
                          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                          {...field}
                        >
                          <option value="diving">Diving</option>
                          <option value="weightroom">Weight Room</option>
                          <option value="dryland">Dryland</option>
                          <option value="mental">Mental Training</option>
                          <option value="other">Other</option>
                        </select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <div className="border p-4 rounded-md space-y-4 mt-2 bg-gray-50">
                  <h3 className="font-medium">Custom recurrence</h3>
                  
                  <div className="flex items-center gap-2">
                    <span>Repeat every</span>
                    <FormField
                      control={practiceForm.control}
                      name="repeatEvery"
                      render={({ field }) => (
                        <FormItem className="w-16">
                          <FormControl>
                            <Input 
                              type="number" 
                              min="1" 
                              className="h-9"
                              {...field}
                              onChange={e => field.onChange(parseInt(e.target.value, 10))} 
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={practiceForm.control}
                      name="repeatUnit"
                      render={({ field }) => (
                        <FormItem className="w-32">
                          <select
                            className="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            {...field}
                          >
                            <option value="day">day</option>
                            <option value="week">week</option>
                            <option value="month">month</option>
                          </select>
                        </FormItem>
                      )}
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <span>Repeat on</span>
                    <div className="flex justify-between gap-2">
                      {[0, 1, 2, 3, 4, 5, 6].map(day => {
                        const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                        const isSelected = practiceForm.watch('repeatDays').includes(day);
                        return (
                          <div 
                            key={day}
                            onClick={() => {
                              const currentDays = [...practiceForm.watch('repeatDays')];
                              if (isSelected) {
                                practiceForm.setValue('repeatDays', currentDays.filter(d => d !== day));
                              } else {
                                practiceForm.setValue('repeatDays', [...currentDays, day].sort());
                              }
                            }}
                            className={`w-8 h-8 rounded-full flex items-center justify-center cursor-pointer ${
                              isSelected 
                                ? 'bg-blue-200 text-blue-800' 
                                : 'bg-gray-200 text-gray-700'
                            }`}
                          >
                            {dayNames[day]}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  
                  <div className="space-y-3">
                    <span>Ends</span>
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <input 
                          type="radio" 
                          id="end-never" 
                          value="never"
                          checked={practiceForm.watch('endOption') === 'never'}
                          onChange={() => practiceForm.setValue('endOption', 'never')}
                          className="w-4 h-4"
                        />
                        <label htmlFor="end-never">Never</label>
                      </div>
                      
                      <div className="flex items-center gap-2">
                        <input 
                          type="radio" 
                          id="end-on" 
                          value="on"
                          checked={practiceForm.watch('endOption') === 'on'}
                          onChange={() => practiceForm.setValue('endOption', 'on')}
                          className="w-4 h-4"
                        />
                        <label htmlFor="end-on">On</label>
                        
                        {practiceForm.watch('endOption') === 'on' && (
                          <FormField
                            control={practiceForm.control}
                            name="endDate"
                            render={({ field }) => (
                              <FormItem className="ml-2">
                                <Popover>
                                  <PopoverTrigger asChild>
                                    <FormControl>
                                      <Button
                                        variant="outline"
                                        className={cn(
                                          "w-full pl-3 text-left font-normal h-9",
                                          !field.value && "text-muted-foreground"
                                        )}
                                      >
                                        {field.value ? (
                                          format(field.value, "MMM d, yyyy")
                                        ) : (
                                          <span>Pick a date</span>
                                        )}
                                        <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                                      </Button>
                                    </FormControl>
                                  </PopoverTrigger>
                                  <PopoverContent className="w-auto p-0" align="start">
                                    <Calendar
                                      mode="single"
                                      selected={field.value}
                                      onSelect={field.onChange}
                                      initialFocus
                                    />
                                  </PopoverContent>
                                </Popover>
                              </FormItem>
                            )}
                          />
                        )}
                      </div>
                      
                      <div className="flex items-center gap-2">
                        <input 
                          type="radio" 
                          id="end-after" 
                          value="after"
                          checked={practiceForm.watch('endOption') === 'after'}
                          onChange={() => practiceForm.setValue('endOption', 'after')}
                          className="w-4 h-4"
                        />
                        <label htmlFor="end-after">After</label>
                        
                        {practiceForm.watch('endOption') === 'after' && (
                          <div className="flex items-center gap-2 ml-2">
                            <FormField
                              control={practiceForm.control}
                              name="endOccurrences"
                              render={({ field }) => (
                                <FormItem className="w-16">
                                  <FormControl>
                                    <Input 
                                      type="number" 
                                      min="1" 
                                      className="h-9"
                                      {...field}
                                      onChange={e => field.onChange(parseInt(e.target.value, 10))} 
                                    />
                                  </FormControl>
                                </FormItem>
                              )}
                            />
                            <span>occurrences</span>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="grid grid-cols-3 gap-4 mt-4">
                  
                  <FormField
                    control={practiceForm.control}
                    name="startTime"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Start Time</FormLabel>
                        <FormControl>
                          <Input type="time" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={practiceForm.control}
                    name="endTime"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>End Time</FormLabel>
                        <FormControl>
                          <Input type="time" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <FormField
                  control={practiceForm.control}
                  name="location"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Location (optional)</FormLabel>
                      <FormControl>
                        <Input placeholder="Pool" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={practiceForm.control}
                  name="notes"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Notes (optional)</FormLabel>
                      <FormControl>
                        <Input placeholder="Additional information" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <Button type="submit" variant="outline" className="w-full">
                  Add Practice
                </Button>
              </form>
            </Form>

            <Separator className="my-4" />

            <div className="space-y-2">
              <h3 className="text-md font-medium">Added Practices</h3>
              {practices.length === 0 ? (
                <p className="text-sm text-gray-500">No practices added yet.</p>
              ) : (
                <div className="space-y-2">
                  {practices.map((practice, index) => (
                    <div key={index} className="flex items-center justify-between rounded-md border p-3">
                      <div>
                        <p className="font-medium">{practice.name}</p>
                        <p className="text-sm text-gray-500">
                          {practice.repeatDays.map(d => getDayName(d).charAt(0)).join(', ')} • {practice.startTime}-{practice.endTime} • {practice.location || 'No location'}
                        </p>
                        <p className="text-xs text-gray-500 capitalize">
                          {practice.type}
                        </p>
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => handleRemovePractice(index)}
                      >
                        <Trash2 className="h-4 w-4 text-red-500" />
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <DialogFooter className="flex justify-between">
              <Button variant="outline" onClick={prevStep}>
                Back
              </Button>
              <Button onClick={nextStep}>
                Next Step <ChevronRight className="ml-2 h-4 w-4" />
              </Button>
            </DialogFooter>
          </div>
        )}

        {step === 5 && (
          <div className="space-y-4 py-4">
            <h2 className="text-lg font-semibold">Review & Create</h2>
            <p className="text-sm text-gray-500">
              Review your season information before creating.
            </p>

            <div className="space-y-4">
              <div className="rounded-md border p-4">
                <h3 className="text-md font-medium mb-2">Season Information</h3>
                <p><span className="font-medium">Name:</span> {form.getValues().name}</p>
                <p><span className="font-medium">Years:</span> {form.getValues().startYear}-{form.getValues().endYear}</p>
              </div>
              
              <div className="rounded-md border p-4">
                <h3 className="text-md font-medium mb-2">Season Stages</h3>
                {stages.length === 0 ? (
                  <p className="text-sm text-gray-500">No stages added.</p>
                ) : (
                  <ul className="list-disc pl-5 space-y-1">
                    {stages.map((stage, index) => (
                      <li key={index} className="text-sm">
                        <span className="capitalize">{stage.type}</span>: Starting {format(stage.startDate, "MMM d, yyyy")}
                      </li>
                    ))}
                  </ul>
                )}
              </div>
              
              <div className="rounded-md border p-4">
                <h3 className="text-md font-medium mb-2">Meets ({meets.length})</h3>
                {meets.length === 0 ? (
                  <p className="text-sm text-gray-500">No meets added.</p>
                ) : (
                  <ul className="list-disc pl-5 space-y-1">
                    {meets.map((meet, index) => (
                      <li key={index} className="text-sm">
                        vs {meet.opponent} - {format(meet.date, "MMM d, yyyy")} ({meet.isHome ? 'Home' : 'Away'})
                      </li>
                    ))}
                  </ul>
                )}
              </div>
              
              <div className="rounded-md border p-4">
                <h3 className="text-md font-medium mb-2">Practices ({practices.length})</h3>
                {practices.length === 0 ? (
                  <p className="text-sm text-gray-500">No practices added.</p>
                ) : (
                  <ul className="list-disc pl-5 space-y-1">
                    {practices.map((practice, index) => (
                      <li key={index} className="text-sm">
                        {practice.name} - {practice.repeatDays.map(d => getDayName(d).charAt(0)).join(', ')} {practice.startTime}-{practice.endTime}
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>

            <DialogFooter className="flex justify-between">
              <Button variant="outline" onClick={prevStep}>
                Back
              </Button>
              <Button 
                onClick={() => submitSeason(form.getValues())}
                disabled={createSeasonMutation.isPending}
              >
                {createSeasonMutation.isPending ? (
                  <>Creating Season...</>
                ) : (
                  <>Create Season</>
                )}
              </Button>
            </DialogFooter>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}